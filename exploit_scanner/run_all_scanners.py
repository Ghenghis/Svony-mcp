#!/usr/bin/env python3
"""
Master Exploit Scanner - Runs all scanners and generates comprehensive report
Finds ALL cheat opportunities across client and AutoEvony
"""

import sys
import json
from pathlib import Path
from datetime import datetime

sys.path.insert(0, str(Path(__file__).parent.parent))

def run_all_scanners():
    """Execute all exploit scanners and combine results"""
    print("\n" + "="*70)
    print(" MASTER EXPLOIT SCANNER - COMPREHENSIVE CHEAT DISCOVERY")
    print(" Scanning: Evony Client + AutoEvony + Network + All Angles")
    print("="*70 + "\n")
    
    all_results = {
        "scan_time": datetime.now().isoformat(),
        "exploits": [],
        "hooks": [],
        "network_exploits": [],
        "autoevony_cheats": [],
        "summary": {}
    }
    
    # Run RAG Exploit Scanner
    print("\n[1/4] Running RAG Exploit Scanner...")
    try:
        from rag_exploit_scanner import RAGExploitScanner
        scanner = RAGExploitScanner()
        exploits = scanner.scan_all()
        all_results["exploits"] = [
            {"name": e.name, "category": e.category.value, 
             "severity": e.severity.value, "location": e.location}
            for e in exploits
        ]
        print(f"      Found {len(exploits)} exploits")
    except Exception as e:
        print(f"      Error: {e}")
    
    # Run Hook Finder
    print("\n[2/4] Running Hook Point Finder...")
    try:
        from hook_finder import HookFinder
        finder = HookFinder()
        hooks = finder.find_all_hooks()
        all_results["hooks"] = [
            {"name": h.name, "type": h.hook_type.value, "location": h.location}
            for h in hooks
        ]
        print(f"      Found {len(hooks)} hook points")
    except Exception as e:
        print(f"      Error: {e}")
    
    # Run Network Exploit Finder
    print("\n[3/4] Running Network Exploit Finder...")
    try:
        from network_exploit_finder import NetworkExploitFinder
        net_finder = NetworkExploitFinder()
        net_finder.find_additional_exploits()
        all_results["network_exploits"] = [
            {"name": e.name, "type": e.exploit_type.value, "command": e.target_command}
            for e in net_finder.exploits
        ]
        print(f"      Found {len(net_finder.exploits)} network exploits")
    except Exception as e:
        print(f"      Error: {e}")
    
    # Run AutoEvony Cheat Finder
    print("\n[4/4] Running AutoEvony Cheat Finder...")
    try:
        from autoevony_cheat_finder import AutoEvonyCheatFinder
        ae_finder = AutoEvonyCheatFinder()
        ae_finder.search_scripts()
        all_results["autoevony_cheats"] = [
            {"name": c.name, "type": c.exploit_type.value, "effectiveness": c.effectiveness}
            for c in ae_finder.cheats
        ]
        print(f"      Found {len(ae_finder.cheats)} AutoEvony cheats")
    except Exception as e:
        print(f"      Error: {e}")
    
    # Calculate summary
    all_results["summary"] = {
        "total_exploits": len(all_results["exploits"]),
        "total_hooks": len(all_results["hooks"]),
        "total_network": len(all_results["network_exploits"]),
        "total_autoevony": len(all_results["autoevony_cheats"]),
        "grand_total": (len(all_results["exploits"]) + len(all_results["hooks"]) +
                       len(all_results["network_exploits"]) + len(all_results["autoevony_cheats"]))
    }
    
    # Save combined JSON
    json_path = Path(__file__).parent / "ALL_EXPLOITS.json"
    json_path.write_text(json.dumps(all_results, indent=2), encoding="utf-8")
    print(f"\n[+] Combined JSON saved to: {json_path}")
    
    # Generate master report
    generate_master_report(all_results)
    
    return all_results


def generate_master_report(results: dict):
    """Generate the master exploit catalog"""
    lines = []
    
    lines.append("# üéØ MASTER EXPLOIT CATALOG\n")
    lines.append("## Complete Cheat Discovery Report\n\n")
    lines.append(f"**Scan Time:** {results['scan_time']}\n\n")
    
    # Grand summary
    s = results["summary"]
    lines.append("## üìä Grand Summary\n\n")
    lines.append(f"| Category | Count |\n")
    lines.append(f"|----------|-------|\n")
    lines.append(f"| Code Exploits | {s['total_exploits']} |\n")
    lines.append(f"| Hook Points | {s['total_hooks']} |\n")
    lines.append(f"| Network Exploits | {s['total_network']} |\n")
    lines.append(f"| AutoEvony Cheats | {s['total_autoevony']} |\n")
    lines.append(f"| **GRAND TOTAL** | **{s['grand_total']}** |\n\n")
    
    lines.append("---\n\n")
    
    # Critical findings
    lines.append("## üî¥ CRITICAL EXPLOITS (Must Try)\n\n")
    
    critical_list = [
        ("Integer Overflow Troop Training", "Train 6.1M archers for free via overflow"),
        ("Food Flip Glitch", "Negative food wraps to billions"),
        ("Weak XOR Encryption", "All traffic trivially decryptable (XOR 0xAA)"),
        ("Predictable Request Signature", "MD5 with known key - forge any request"),
        ("Client-Side Validation Only", "Many checks only on client, server trusts"),
        ("Packet Replay Attack", "Replay captured packets for duplicate actions"),
        ("Negative Resource Transport", "Send negative resources to steal from others"),
    ]
    
    for name, desc in critical_list:
        lines.append(f"### ‚ö†Ô∏è {name}\n{desc}\n\n")
    
    lines.append("---\n\n")
    
    # Exploits by category
    lines.append("## üìÅ All Code Exploits\n\n")
    if results["exploits"]:
        by_cat = {}
        for e in results["exploits"]:
            cat = e["category"]
            if cat not in by_cat:
                by_cat[cat] = []
            by_cat[cat].append(e)
        
        for cat, exploits in sorted(by_cat.items()):
            lines.append(f"### {cat.upper()}\n")
            for e in exploits[:10]:
                lines.append(f"- **{e['name']}** - `{e['location']}`\n")
            if len(exploits) > 10:
                lines.append(f"- ... and {len(exploits)-10} more\n")
            lines.append("\n")
    
    # Hook points
    lines.append("## üé£ Hook Points\n\n")
    if results["hooks"]:
        by_type = {}
        for h in results["hooks"]:
            t = h["type"]
            if t not in by_type:
                by_type[t] = []
            by_type[t].append(h)
        
        for t, hooks in sorted(by_type.items()):
            lines.append(f"### {t.upper()}\n")
            for h in hooks[:10]:
                lines.append(f"- **{h['name']}** - `{h['location']}`\n")
            if len(hooks) > 10:
                lines.append(f"- ... and {len(hooks)-10} more\n")
            lines.append("\n")
    
    # Network exploits
    lines.append("## üåê Network Exploits\n\n")
    if results["network_exploits"]:
        by_type = {}
        for n in results["network_exploits"]:
            t = n["type"]
            if t not in by_type:
                by_type[t] = []
            by_type[t].append(n)
        
        for t, nets in sorted(by_type.items()):
            lines.append(f"### {t.upper()}\n")
            for n in nets:
                lines.append(f"- **{n['name']}** - Target: `{n['command']}`\n")
            lines.append("\n")
    
    # AutoEvony cheats
    lines.append("## ü§ñ AutoEvony Script Cheats\n\n")
    if results["autoevony_cheats"]:
        by_type = {}
        for a in results["autoevony_cheats"]:
            t = a["type"]
            if t not in by_type:
                by_type[t] = []
            by_type[t].append(a)
        
        for t, cheats in sorted(by_type.items()):
            lines.append(f"### {t.upper()}\n")
            for c in cheats:
                lines.append(f"- **{c['name']}** - Effectiveness: {c['effectiveness']}\n")
            lines.append("\n")
    
    lines.append("---\n\n")
    
    # Quick reference cheat codes
    lines.append("## ‚ö° Quick Reference - Ready-to-Use Cheats\n\n")
    lines.append("### AutoEvony Scripts\n")
    lines.append("```\n")
    lines.append("; Archer overflow (6.1M for free)\n")
    lines.append("train a:6135037\n\n")
    lines.append("; Worker overflow (42.9M for free)\n")
    lines.append("train wo:42949673\n\n")
    lines.append("; Catapult overflow (715K)\n")
    lines.append("train cp:715828\n\n")
    lines.append("; Rapid fire flood (no delays)\n")
    lines.append("setsilence true\n")
    lines.append("config delay:0\n")
    lines.append("loop 100\n")
    lines.append("    train a:1000\n")
    lines.append("endloop\n")
    lines.append("```\n\n")
    
    lines.append("### Python Network Exploits\n")
    lines.append("```python\n")
    lines.append("# Decrypt XOR traffic\n")
    lines.append("def decrypt(data): return bytes([b ^ 0xAA for b in data])\n\n")
    lines.append("# Forge request signature\n")
    lines.append("import hashlib\n")
    lines.append("ACTION_KEY = 'TAO_{313-894*&*($*#-FDIU(430}-{facebook_dioe(&*%$l}'\n")
    lines.append("def sign(params): return hashlib.md5((params + ACTION_KEY).encode()).hexdigest()\n")
    lines.append("```\n\n")
    
    lines.append("---\n\n")
    lines.append("## üìö Full Reports\n\n")
    lines.append("- [EXPLOIT_SCAN_RESULTS.md](EXPLOIT_SCAN_RESULTS.md) - All code exploits\n")
    lines.append("- [HOOK_POINTS.md](HOOK_POINTS.md) - All injection points\n")
    lines.append("- [NETWORK_EXPLOITS.md](NETWORK_EXPLOITS.md) - All network attacks\n")
    lines.append("- [AUTOEVONY_CHEATS.md](AUTOEVONY_CHEATS.md) - All script cheats\n")
    lines.append("- [ALL_EXPLOITS.json](ALL_EXPLOITS.json) - Machine-readable data\n")
    
    # Save report
    report = "".join(lines)
    output = Path(__file__).parent / "MASTER_EXPLOIT_CATALOG.md"
    output.write_text(report, encoding="utf-8")
    print(f"[+] Master catalog saved to: {output}")


def main():
    results = run_all_scanners()
    
    print("\n" + "="*70)
    print(" SCAN COMPLETE")
    print("="*70)
    print(f"\n Total Findings: {results['summary']['grand_total']}")
    print(f"   - Code Exploits: {results['summary']['total_exploits']}")
    print(f"   - Hook Points: {results['summary']['total_hooks']}")
    print(f"   - Network Exploits: {results['summary']['total_network']}")
    print(f"   - AutoEvony Cheats: {results['summary']['total_autoevony']}")
    print("\n Check exploit_scanner/ directory for all reports")


if __name__ == "__main__":
    main()
