#!/usr/bin/env python3
"""
AutoEvony Cheat Finder - Discovers all cheat opportunities in AutoEvony scripting
Finds script-based exploits, command abuse, and automation hacks
"""

import sys
import json
from pathlib import Path
from dataclasses import dataclass
from typing import List, Dict
from enum import Enum

sys.path.insert(0, str(Path(__file__).parent.parent))

class AutoEvonyExploitType(Enum):
    OVERFLOW_SCRIPT = "overflow_script"
    TIMING_ABUSE = "timing_abuse"
    LOOP_EXPLOIT = "loop_exploit"
    MULTI_CITY = "multi_city"
    RACE_SCRIPT = "race_script"
    VALIDATION_BYPASS = "validation_bypass"
    RESOURCE_EXPLOIT = "resource_exploit"
    ARMY_EXPLOIT = "army_exploit"

@dataclass
class AutoEvonyCheat:
    name: str
    exploit_type: AutoEvonyExploitType
    description: str
    script_code: str
    how_it_works: str
    requirements: List[str]
    detection_risk: str
    effectiveness: str

# All AutoEvony script-based cheats
AUTOEVONY_CHEATS = [
    # INTEGER OVERFLOW SCRIPTS
    AutoEvonyCheat(
        name="Archer Overflow Training",
        exploit_type=AutoEvonyExploitType.OVERFLOW_SCRIPT,
        description="Train massive archers using integer overflow",
        script_code="""
; Archer Overflow Exploit Script
; Threshold: 6,135,037 archers = cost overflow
; Food cost: 350 per archer
; 6,135,037 * 350 = 2,147,262,950 > INT32_MAX

setvar overflow_count 6135037
loop 10
    train a:%overflow_count%
    wait 1
endloop

; Result: 61+ million archers for almost free
""",
        how_it_works="""
1. Calculate overflow threshold: INT32_MAX / food_cost + 1
2. Archers cost 350 food each
3. 2,147,483,647 / 350 = 6,135,667
4. Training 6,135,037 costs 2,147,262,950 (wraps to negative)
5. Server may credit negative cost as resource gain
""",
        requirements=["High population", "Multiple barracks", "Low detection server"],
        detection_risk="MEDIUM - Unusual training numbers",
        effectiveness="CRITICAL - Can generate billions of troops"
    ),
    
    AutoEvonyCheat(
        name="Worker Mass Training",
        exploit_type=AutoEvonyExploitType.OVERFLOW_SCRIPT,
        description="Train workers with lowest cost for easiest overflow",
        script_code="""
; Worker Overflow - Lowest threshold
; Workers cost 50 food each
; Threshold: 42,949,673 workers

setvar worker_overflow 42949673
train wo:%worker_overflow%

; Convert workers to resources via dismiss
dismiss wo:42000000
""",
        how_it_works="""
1. Workers have lowest food cost (50)
2. Overflow threshold: 2,147,483,647 / 50 = 42,949,672
3. Train 42,949,673 workers
4. Cost wraps to negative
5. Dismiss for resource refund
""",
        requirements=["Population capacity"],
        detection_risk="LOW - Workers commonly mass-trained",
        effectiveness="HIGH"
    ),
    
    AutoEvonyCheat(
        name="Catapult Cost Flip",
        exploit_type=AutoEvonyExploitType.OVERFLOW_SCRIPT,
        description="Catapults have high cost - lower threshold",
        script_code="""
; Catapult overflow - only need 715,828
; Cost: 3000 food each

setvar cat_overflow 715828
loop 5
    train cp:%cat_overflow%
    wait 2
endloop

; 3.5+ million catapults
""",
        how_it_works="""
1. Catapults cost 3000 food
2. Threshold: 2,147,483,647 / 3000 = 715,827
3. Only need ~716K to overflow
4. Easier to achieve than archers
""",
        requirements=["Workshop level 10", "Military research"],
        detection_risk="MEDIUM",
        effectiveness="HIGH"
    ),
    
    # TIMING ABUSE SCRIPTS
    AutoEvonyCheat(
        name="Rapid Fire Command Flood",
        exploit_type=AutoEvonyExploitType.TIMING_ABUSE,
        description="Send commands faster than server can process",
        script_code="""
; Disable all delays
setsilence true
config delay:0

; Rapid fire training
loop 100
    train a:1000
    ; No wait - maximum speed
endloop

; May bypass server-side rate limits
""",
        how_it_works="""
1. Remove all client-side delays
2. Send commands at maximum speed
3. Server queue may overflow
4. Some commands may duplicate
""",
        requirements=["Fast connection", "setsilence enabled"],
        detection_risk="HIGH - Rate limit triggers",
        effectiveness="MEDIUM"
    ),
    
    AutoEvonyCheat(
        name="Cooldown Bypass Script",
        exploit_type=AutoEvonyExploitType.TIMING_ABUSE,
        description="Time commands exactly at cooldown expiry",
        script_code="""
; Track cooldown precisely
setvar cd_time 900  ; 15 min in seconds

label tax_loop
    interior taxrate 20  ; Collect tax
    wait %cd_time%
    goto tax_loop

; Alternative: Calculate exact server time
; and send command 1ms before cooldown ends
""",
        how_it_works="""
1. Track server cooldown precisely
2. Send command exactly when CD ends
3. May process before CD check completes
4. Race condition exploit
""",
        requirements=["Precise timing", "Server sync"],
        detection_risk="LOW",
        effectiveness="MEDIUM"
    ),
    
    # LOOP EXPLOITS
    AutoEvonyCheat(
        name="Infinite NPC Farm Loop",
        exploit_type=AutoEvonyExploitType.LOOP_EXPLOIT,
        description="Continuously farm NPCs for infinite resources",
        script_code="""
; Infinite NPC farming script
config npc:10
config valley:0
distancepolicy 50 10 50 30

label farm_forever
    ; Find all level 10 NPCs in range
    findnpc 10
    
    ; Attack each one
    foreach npc in %npcs%
        attack %npc%
        wait 5
    endfor
    
    ; Wait for armies to return
    wait 600
    goto farm_forever
""",
        how_it_works="""
1. Continuously scan for NPCs
2. Attack all in range
3. Collect resources on return
4. Repeat forever
5. 24/7 resource generation
""",
        requirements=["Sufficient troops", "Heroes available"],
        detection_risk="LOW - Normal gameplay",
        effectiveness="HIGH - Unlimited resources over time"
    ),
    
    AutoEvonyCheat(
        name="Hero Experience Farm",
        exploit_type=AutoEvonyExploitType.LOOP_EXPLOIT,
        description="Farm hero experience continuously",
        script_code="""
; Level heroes infinitely
config npc:5  ; Easy NPCs for fast kills

label hero_farm
    ; Get all idle heroes
    getheroes idle
    
    foreach hero in %heroes%
        ; Send to easy NPC
        findnpc 5
        attack %npcs[0]% hero:%hero%
        wait 60
    endfor
    
    goto hero_farm
""",
        how_it_works="""
1. Send heroes to easy battles
2. Collect experience
3. Repeat continuously
4. Max level heroes
""",
        requirements=["Multiple heroes", "Patience"],
        detection_risk="LOW",
        effectiveness="MEDIUM"
    ),
    
    # MULTI-CITY EXPLOITS
    AutoEvonyCheat(
        name="Multi-City Resource Transfer",
        exploit_type=AutoEvonyExploitType.MULTI_CITY,
        description="Exploit multi-city mechanics for resource multiplication",
        script_code="""
; Transfer resources between cities rapidly
setvar cities 9  ; Max cities

loop %cities%
    selectcity %loop_index%
    
    ; Collect from this city
    interior taxrate 100
    
    ; Transfer to main city
    transport 100,100 r:all
    wait 1
endloop

; All resources concentrated
""",
        how_it_works="""
1. Maximize tax in all cities
2. Transport everything to one city
3. Resources from 9 cities combined
4. Then use overflow exploits
""",
        requirements=["Multiple cities", "Transporters"],
        detection_risk="LOW",
        effectiveness="HIGH"
    ),
    
    AutoEvonyCheat(
        name="Parallel City Training",
        exploit_type=AutoEvonyExploitType.MULTI_CITY,
        description="Train troops in all cities simultaneously",
        script_code="""
; Train in all cities at once
setvar troop_type a
setvar troop_count 10000

loop 9
    selectcity %loop_index%
    train %troop_type%:%troop_count%
endloop

; 90,000 troops training simultaneously
; Apply overflow to all cities
""",
        how_it_works="""
1. Loop through all cities
2. Issue training command in each
3. Multiplies troop production
4. Combine with overflow for massive armies
""",
        requirements=["9 cities", "Barracks in each"],
        detection_risk="LOW",
        effectiveness="HIGH"
    ),
    
    # RACE CONDITION SCRIPTS
    AutoEvonyCheat(
        name="Item Duplication Race",
        exploit_type=AutoEvonyExploitType.RACE_SCRIPT,
        description="Rapid item use to potentially duplicate",
        script_code="""
; Use item as fast as possible
; May process multiple times

setvar item_id 12345
setvar count 10

loop %count%
    useitem %item_id%
    ; NO WAIT - race condition
endloop

; Server may apply item effect multiple times
""",
        how_it_works="""
1. Send item use command rapidly
2. Before server updates inventory
3. Server may process all
4. Item effect multiplied
""",
        requirements=["Valuable items", "Fast execution"],
        detection_risk="MEDIUM",
        effectiveness="MEDIUM"
    ),
    
    AutoEvonyCheat(
        name="Building Queue Race",
        exploit_type=AutoEvonyExploitType.RACE_SCRIPT,
        description="Queue buildings faster than server validates",
        script_code="""
; Rapid building upgrades
loop 10
    upgrade 1001  ; Townhall
    ; No wait between
endloop

; May queue more than allowed
""",
        how_it_works="""
1. Send upgrade commands rapidly
2. Before queue limit checked
3. May exceed queue limit
4. Build faster than intended
""",
        requirements=["Resources", "Building slots"],
        detection_risk="MEDIUM",
        effectiveness="LOW"
    ),
    
    # VALIDATION BYPASS
    AutoEvonyCheat(
        name="Visitor Mode Bypass",
        exploit_type=AutoEvonyExploitType.VALIDATION_BYPASS,
        description="Execute commands that should be blocked for visitors",
        script_code="""
; AutoEvony may not check visitor status
; Some commands might work

; These normally blocked for visitors:
train a:1000
upgrade 1001
attack 100,100

; Bot sends directly, bypassing client check
""",
        how_it_works="""
1. Client checks bVisitor flag
2. AutoEvony sends commands directly
3. Bypasses client-side validation
4. Server may not validate
""",
        requirements=["Visitor account (for testing)"],
        detection_risk="HIGH - Server likely checks",
        effectiveness="LOW"
    ),
    
    AutoEvonyCheat(
        name="Requirement Bypass",
        exploit_type=AutoEvonyExploitType.VALIDATION_BYPASS,
        description="Send commands without meeting requirements",
        script_code="""
; Send upgrade without checking requirements
; Client normally validates first

upgrade 1001  ; Townhall to level 11
              ; Even if requirements not met

; AutoEvony doesn't check prerequisites
; Server validation is the question
""",
        how_it_works="""
1. Client validates requirements
2. Bot sends command directly
3. Skips client-side validation
4. Tests server validation
""",
        requirements=["Building to upgrade"],
        detection_risk="HIGH",
        effectiveness="LOW - Server usually validates"
    ),
    
    # RESOURCE EXPLOITS
    AutoEvonyCheat(
        name="Tax Rate Exploit",
        exploit_type=AutoEvonyExploitType.RESOURCE_EXPLOIT,
        description="Maximize gold through tax manipulation",
        script_code="""
; Aggressive tax collection script
label tax_exploit
    ; Set max tax
    interior taxrate 100
    wait 1
    
    ; Immediately reset to rebuild loyalty
    interior taxrate 0
    wait 300  ; Let loyalty recover
    
    ; Repeat
    goto tax_exploit

; Alternative: Comfort rate manipulation
interior comfort 100  ; Max comfort
wait 60
interior comfort 0
""",
        how_it_works="""
1. Set tax rate to maximum
2. Collect immediately
3. Reset before loyalty drops too much
4. Repeat for continuous gold
""",
        requirements=["High population"],
        detection_risk="LOW - Normal gameplay",
        effectiveness="MEDIUM"
    ),
    
    AutoEvonyCheat(
        name="Valley Resource Farm",
        exploit_type=AutoEvonyExploitType.RESOURCE_EXPLOIT,
        description="Capture valleys for resource bonus",
        script_code="""
; Capture all high-level valleys
config valley:10

label valley_capture
    ; Find unclaimed valleys
    scanmap %city_coords% 100
    
    foreach valley in %valleys%
        if %valley.level% >= 8
            attack %valley%
            wait 60
        endif
    endfor
    
    wait 3600
    goto valley_capture
""",
        how_it_works="""
1. Scan for high-level valleys
2. Capture all in range
3. Get resource production bonus
4. Maintain control
""",
        requirements=["Troops", "Available valley slots"],
        detection_risk="LOW",
        effectiveness="MEDIUM"
    ),
    
    # ARMY EXPLOITS
    AutoEvonyCheat(
        name="Army Recall Exploit",
        exploit_type=AutoEvonyExploitType.ARMY_EXPLOIT,
        description="Recall armies to potentially duplicate",
        script_code="""
; Send army then immediately recall
attack 500,500 troops:a:10000

; Rapid recall
wait 0.1
recall

; Troops may return with resources
; But also stay at destination?
""",
        how_it_works="""
1. Send army to target
2. Immediately recall
3. Server state may desync
4. Potential resource/troop duplication
""",
        requirements=["Troops", "Target coordinates"],
        detection_risk="MEDIUM",
        effectiveness="LOW - Unlikely to work"
    ),
    
    AutoEvonyCheat(
        name="Mass Scout Intel",
        exploit_type=AutoEvonyExploitType.ARMY_EXPLOIT,
        description="Scout entire map for intelligence",
        script_code="""
; Comprehensive map scouting
setvar scout_count 10

; Generate all coordinates in range
loop 800
    loop 800
        setvar x %outer_loop%
        setvar y %inner_loop%
        
        ; Scout this coord
        scout %x%,%y% s:%scout_count%
        wait 0.5
    endloop
endloop

; Full map intelligence
""",
        how_it_works="""
1. Generate all map coordinates
2. Scout each one
3. Build complete map picture
4. Find all targets, resources, players
""",
        requirements=["Many scouts", "Time"],
        detection_risk="MEDIUM - Unusual scout activity",
        effectiveness="HIGH - Complete intel"
    ),
]


class AutoEvonyCheatFinder:
    """Finds and catalogs AutoEvony script cheats"""
    
    def __init__(self):
        self.cheats = AUTOEVONY_CHEATS.copy()
        self.rag = None
        self._init_rag()
    
    def _init_rag(self):
        try:
            from evony_rag.rag_v2 import EvonyRAGv2
            self.rag = EvonyRAGv2()
            self.rag.policy.set_mode("full_access")
            print("[+] RAG initialized")
        except:
            print("[!] RAG not available")
    
    def search_scripts(self):
        """Search existing scripts for exploit patterns"""
        if not self.rag:
            return
        
        print("\n[*] Searching scripts for exploit patterns...")
        
        queries = [
            "train overflow loop infinite",
            "wait 0 rapid fast flood",
            "exploit cheat hack",
            "bypass skip requirement",
        ]
        
        for q in queries:
            try:
                results = self.rag.search_only(q, k=10)
                for r in results:
                    if "script" in r.file.lower():
                        print(f"  Found script: {r.file}")
            except:
                pass
    
    def generate_report(self) -> str:
        """Generate AutoEvony cheat report"""
        lines = []
        lines.append("# ðŸ¤– AUTOEVONY CHEAT CATALOG\n\n")
        lines.append(f"**Total Script Cheats:** {len(self.cheats)}\n\n")
        
        # Summary
        by_type = {}
        for c in self.cheats:
            t = c.exploit_type.value
            by_type[t] = by_type.get(t, 0) + 1
        
        lines.append("## Summary by Type\n")
        for t, count in sorted(by_type.items(), key=lambda x: -x[1]):
            lines.append(f"- **{t}**: {count}\n")
        
        lines.append("\n---\n")
        
        # By type
        for exploit_type in AutoEvonyExploitType:
            cheats = [c for c in self.cheats if c.exploit_type == exploit_type]
            if cheats:
                lines.append(f"\n## {exploit_type.value.upper().replace('_', ' ')}\n")
                for c in cheats:
                    lines.append(self._format_cheat(c))
        
        return "".join(lines)
    
    def _format_cheat(self, c: AutoEvonyCheat) -> str:
        reqs = "\n".join(f"- {r}" for r in c.requirements)
        return f"""
### {c.name}
**Effectiveness:** {c.effectiveness}  
**Detection Risk:** {c.detection_risk}

**Description:** {c.description}

**Script Code:**
```
{c.script_code}
```

**How It Works:**
{c.how_it_works}

**Requirements:**
{reqs}

---
"""


def main():
    finder = AutoEvonyCheatFinder()
    finder.search_scripts()
    
    print(f"\n[+] Total AutoEvony cheats: {len(finder.cheats)}")
    
    report = finder.generate_report()
    output = Path(__file__).parent / "AUTOEVONY_CHEATS.md"
    output.write_text(report, encoding="utf-8")
    print(f"[+] Report saved to: {output}")
    
    # JSON
    json_path = Path(__file__).parent / "autoevony_cheats.json"
    data = [{"name": c.name, "type": c.exploit_type.value,
             "description": c.description, "risk": c.detection_risk,
             "effectiveness": c.effectiveness} for c in finder.cheats]
    json_path.write_text(json.dumps(data, indent=2), encoding="utf-8")
    print(f"[+] JSON saved to: {json_path}")


if __name__ == "__main__":
    main()
