# Evony Exploits & Vulnerabilities

Documented exploits extracted from reverse engineering analysis.

## 1. Integer Overflow Exploit (Troop Glitch)

**Status**: WORKING  
**Severity**: CRITICAL  
**Category**: Resource Manipulation

### Mechanism
The server uses signed 32-bit integers for resource calculations. Training troops above certain thresholds causes integer overflow, resulting in negative costs.

### Overflow Thresholds

| Troop Type | Food Cost | Threshold | Formula |
|------------|-----------|-----------|---------|
| Archer | 350 | **6,135,037** | INT32_MAX / 350 + 1 |
| Worker | 50 | **42,949,673** | INT32_MAX / 50 + 1 |
| Catapult | 3000 | **715,828** | INT32_MAX / 3000 + 1 |
| Cavalry | 500 | **4,294,968** | INT32_MAX / 500 + 1 |
| Warrior | 100 | **21,474,837** | INT32_MAX / 100 + 1 |

### Exploit Steps
```
1. Queue troops at threshold + 1 quantity
2. Server calculates: cost = num * food_cost
3. Overflow wraps to negative value
4. Server deducts negative cost (adds resources)
5. Cancel production to keep resources
6. Repeat for infinite resources
```

### AutoEvony Script
```
; Train 6,135,037 archers to trigger overflow
train a:6135037
wait 2
; Cancel to get resources back + overflow bonus
cancel a
```

### Calculator Function
```python
def calculate_overflow(troop_cost: int, quantity: int) -> dict:
    INT32_MAX = 2147483647
    raw_cost = troop_cost * quantity
    overflowed = raw_cost > INT32_MAX
    wrapped = raw_cost & 0xFFFFFFFF
    if wrapped > INT32_MAX:
        wrapped = wrapped - 0x100000000  # Convert to signed
    return {
        'raw_cost': raw_cost,
        'overflowed': overflowed,
        'wrapped_value': wrapped,
        'exploit_viable': overflowed and wrapped < 0,
        'gain_on_cancel': abs(wrapped) if wrapped < 0 else 0
    }
```

---

## 2. Race Condition Exploits

**Status**: VARIABLE (depends on server load)  
**Severity**: HIGH  
**Category**: Timing Attack

### Mechanism
Command handlers lack proper locking, allowing duplicate resource gains.

### Exploit Flow
```
Normal flow:
1. Client sends "use item"
2. Server checks inventory
3. Server applies effect
4. Server removes item

Race condition:
1. Client sends "use item" x5 simultaneously
2. All 5 pass inventory check (item exists)
3. All 5 apply effect
4. Only 1 removes item
Result: 5x benefit from 1 item
```

### Vulnerable Commands
- `shop.useItem` - Use consumable items
- `trade.acceptTrade` - Accept market trades
- `army.collectReward` - Collect quest rewards
- `castle.collectTax` - Collect city taxes

### Mitigation Required
Server needs mutex/locks per resource type.

---

## 3. Session Hijacking

**Status**: WORKING  
**Severity**: HIGH  
**Category**: Authentication

### Mechanism
Session keys are predictable and transmitted without encryption.

### Attack Vector
```
1. Intercept AMF traffic (no SSL on game port)
2. Extract sessionKey from any command
3. Replay commands with captured session
4. Session valid until explicit logout
```

### Session Key Structure
```
sessionKey = base64(userId + timestamp + random)
```

---

## 4. AMF Deserialization

**Status**: THEORETICAL  
**Severity**: MEDIUM  
**Category**: Injection

### Mechanism
AMF3 deserialization may instantiate arbitrary classes.

### Payload Structure
```
AMF3 Object with:
- className: "dangerous.class.Name"
- properties: {malicious: data}
```

---

## 5. Command Injection

**Status**: PATCHED (mostly)  
**Severity**: MEDIUM  
**Category**: Injection

### Mechanism
Some string parameters not properly sanitized.

### Vulnerable Parameters
- Alliance names
- City names  
- Mail content
- Chat messages

### Payload Examples
```
cityName: "Test<script>alert(1)</script>"
allianceMotto: "'; DROP TABLE players;--"
```

---

## 6. Resource Duplication

**Status**: WORKING  
**Severity**: HIGH  
**Category**: Logic Flaw

### Mechanism
Cancel operations refund resources without proper state validation.

### Steps
```
1. Start building upgrade (resources deducted)
2. Quickly send resources to another city
3. Cancel upgrade (resources refunded)
4. Both cities now have the resources
```

### Timing Window
~500ms between deduction and state lock

---

## Exploit Detection

### Server-Side Indicators
```python
# Detect overflow attempts
if troop_quantity > 1000000:
    flag_suspicious(player_id, "overflow_attempt")

# Detect race conditions
if command_rate > 10_per_second:
    flag_suspicious(player_id, "race_condition")

# Detect resource anomalies
if resource_gain > expected_max:
    flag_suspicious(player_id, "resource_anomaly")
```

### Client Fingerprints
- AutoEvony: User-Agent contains "AutoEvony"
- Bot scripts: Command timing too precise (< 50ms variance)
- Exploits: Impossible resource values

---

## Disclaimer

This documentation is for **educational and security research purposes only**. Using these exploits on live servers may violate terms of service and applicable laws.
