# Evony Architecture Diagrams

## System Overview

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           EVONY GAME ARCHITECTURE                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐  │
│  │   Flash     │    │   HTTP      │    │   Game      │    │   MySQL     │  │
│  │   Client    │───▶│   Proxy     │───▶│   Server    │───▶│   Database  │  │
│  │  (SWF)      │    │   (AMF)     │    │   (Java)    │    │             │  │
│  └─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘  │
│        │                                      │                             │
│        │            ┌─────────────┐           │                             │
│        └───────────▶│   Policy    │◀──────────┘                             │
│                     │   Server    │                                         │
│                     └─────────────┘                                         │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## AMF Protocol Flow

```
┌──────────────────────────────────────────────────────────────────────────┐
│                         AMF COMMAND FLOW                                  │
├──────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│   CLIENT                          SERVER                                 │
│   ──────                          ──────                                 │
│                                                                          │
│   ┌─────────────┐                                                        │
│   │ User Action │                                                        │
│   └──────┬──────┘                                                        │
│          │                                                               │
│          ▼                                                               │
│   ┌─────────────┐                                                        │
│   │ Build Params│                                                        │
│   └──────┬──────┘                                                        │
│          │                                                               │
│          ▼                                                               │
│   ┌─────────────┐                                                        │
│   │ Generate    │  signature = MD5(data + ACTION_KEY)                    │
│   │ Signature   │                                                        │
│   └──────┬──────┘                                                        │
│          │                                                               │
│          ▼                                                               │
│   ┌─────────────┐      ┌─────────────┐                                   │
│   │ AMF3        │─────▶│ HTTP POST   │                                   │
│   │ Serialize   │      │ /gateway    │                                   │
│   └─────────────┘      └──────┬──────┘                                   │
│                               │                                          │
│                               ▼                                          │
│                        ┌─────────────┐                                   │
│                        │ Verify Sig  │                                   │
│                        └──────┬──────┘                                   │
│                               │                                          │
│                               ▼                                          │
│                        ┌─────────────┐                                   │
│                        │ Execute Cmd │                                   │
│                        └──────┬──────┘                                   │
│                               │                                          │
│                               ▼                                          │
│   ┌─────────────┐      ┌─────────────┐                                   │
│   │ AMF3        │◀─────│ Build       │                                   │
│   │ Deserialize │      │ Response    │                                   │
│   └──────┬──────┘      └─────────────┘                                   │
│          │                                                               │
│          ▼                                                               │
│   ┌─────────────┐                                                        │
│   │ Update UI   │                                                        │
│   └─────────────┘                                                        │
│                                                                          │
└──────────────────────────────────────────────────────────────────────────┘
```

## Troop Overflow Exploit Flow

```
┌──────────────────────────────────────────────────────────────────────────┐
│                    INTEGER OVERFLOW EXPLOIT FLOW                          │
├──────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│   STEP 1: Calculate Threshold                                            │
│   ┌─────────────────────────────────────────────────────────────────┐    │
│   │  threshold = (INT32_MAX / troop_cost) + 1                       │    │
│   │  For archers (cost=350): threshold = 6,135,037                  │    │
│   └─────────────────────────────────────────────────────────────────┘    │
│                                                                          │
│   STEP 2: Queue Troops                                                   │
│   ┌─────────────────────────────────────────────────────────────────┐    │
│   │  Client: troop.produceTroop(cityId, ARCHER, 6135037)            │    │
│   └─────────────────────────────────────────────────────────────────┘    │
│                          │                                               │
│                          ▼                                               │
│   STEP 3: Server Calculation (OVERFLOW!)                                 │
│   ┌─────────────────────────────────────────────────────────────────┐    │
│   │  cost = 6,135,037 × 350 = 2,147,262,950                         │    │
│   │  BUT: INT32 wraps to NEGATIVE: -2,147,704,346                   │    │
│   │  Server ADDS resources instead of deducting!                    │    │
│   └─────────────────────────────────────────────────────────────────┘    │
│                          │                                               │
│                          ▼                                               │
│   STEP 4: Cancel Production                                              │
│   ┌─────────────────────────────────────────────────────────────────┐    │
│   │  Client: troop.cancelProduceTroop(cityId, ARCHER)               │    │
│   │  Resources returned (already gained from overflow)              │    │
│   └─────────────────────────────────────────────────────────────────┘    │
│                          │                                               │
│                          ▼                                               │
│   RESULT: Infinite Resources                                             │
│   ┌─────────────────────────────────────────────────────────────────┐    │
│   │  ✓ Food: +2,147,704,346 (from overflow)                         │    │
│   │  ✓ Repeat for other resources                                   │    │
│   │  ✓ No troops actually trained                                   │    │
│   └─────────────────────────────────────────────────────────────────┘    │
│                                                                          │
└──────────────────────────────────────────────────────────────────────────┘
```

## Race Condition Exploit Flow

```
┌──────────────────────────────────────────────────────────────────────────┐
│                      RACE CONDITION EXPLOIT FLOW                          │
├──────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│   NORMAL FLOW (Single Request)                                           │
│   ────────────────────────────                                           │
│   T=0ms   [Check Item]  ──▶  Item exists? YES                            │
│   T=5ms   [Apply Effect] ──▶  +1000 gold                                 │
│   T=10ms  [Remove Item]  ──▶  Item count: 0                              │
│   RESULT: 1 item = 1000 gold ✓                                           │
│                                                                          │
│   ─────────────────────────────────────────────────────────────────────  │
│                                                                          │
│   RACE CONDITION (5 Simultaneous Requests)                               │
│   ─────────────────────────────────────────                              │
│                                                                          │
│   T=0ms   [Check Item] ×5  ──▶  All see: Item exists? YES                │
│           │    │    │    │    │                                          │
│           ▼    ▼    ▼    ▼    ▼                                          │
│   T=5ms   [Apply Effect] ×5 ──▶  +1000 +1000 +1000 +1000 +1000           │
│           │    │    │    │    │                                          │
│           ▼    ▼    ▼    ▼    ▼                                          │
│   T=10ms  [Remove Item] ×5  ──▶  Only 1 succeeds (item gone)             │
│                                                                          │
│   RESULT: 1 item = 5000 gold! (5× benefit)                               │
│                                                                          │
│   ─────────────────────────────────────────────────────────────────────  │
│                                                                          │
│   TIMING DIAGRAM                                                         │
│                                                                          │
│   Request 1: ═══[CHECK]═══[APPLY]═══[REMOVE]                             │
│   Request 2: ═══[CHECK]═══[APPLY]═══[FAIL]                               │
│   Request 3: ═══[CHECK]═══[APPLY]═══[FAIL]                               │
│   Request 4: ═══[CHECK]═══[APPLY]═══[FAIL]                               │
│   Request 5: ═══[CHECK]═══[APPLY]═══[FAIL]                               │
│              ↑                                                           │
│              └── All checks pass before any removal                      │
│                                                                          │
└──────────────────────────────────────────────────────────────────────────┘
```

## MCP Server Architecture

```
┌──────────────────────────────────────────────────────────────────────────┐
│                     SVONY MCP SERVER ARCHITECTURE                         │
├──────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│   ┌─────────────────────────────────────────────────────────────────┐    │
│   │                         WINDSURF IDE                             │    │
│   │   ┌─────────────┐    ┌─────────────┐    ┌─────────────┐         │    │
│   │   │   Cascade   │    │    MCP      │    │   Other     │         │    │
│   │   │   (AI)      │───▶│   Client    │    │   MCPs      │         │    │
│   │   └─────────────┘    └──────┬──────┘    └─────────────┘         │    │
│   └─────────────────────────────┼───────────────────────────────────┘    │
│                                 │ JSON-RPC (stdio)                       │
│                                 ▼                                        │
│   ┌─────────────────────────────────────────────────────────────────┐    │
│   │                    evony_mcp_wrapper.js                          │    │
│   │   ┌─────────────┐    ┌─────────────┐    ┌─────────────┐         │    │
│   │   │   stdin     │───▶│   Forward   │───▶│   Python    │         │    │
│   │   │   readline  │    │   Lines     │    │   stdin     │         │    │
│   │   └─────────────┘    └─────────────┘    └─────────────┘         │    │
│   │   • Ignores stderr (Windsurf compatibility)                      │    │
│   │   • Keeps stdin pipe open                                        │    │
│   └─────────────────────────────┼───────────────────────────────────┘    │
│                                 │                                        │
│                                 ▼                                        │
│   ┌─────────────────────────────────────────────────────────────────┐    │
│   │                   mcp_server_clean.py                            │    │
│   │   ┌─────────────┐    ┌─────────────┐    ┌─────────────┐         │    │
│   │   │   Parse     │───▶│   Handle    │───▶│   Send      │         │    │
│   │   │   JSON-RPC  │    │   Request   │    │   Response  │         │    │
│   │   └─────────────┘    └──────┬──────┘    └─────────────┘         │    │
│   │   • Logs to file only (no stderr!)                               │    │
│   │   • BOM handling for Windsurf                                    │    │
│   └─────────────────────────────┼───────────────────────────────────┘    │
│                                 │                                        │
│                                 ▼                                        │
│   ┌─────────────────────────────────────────────────────────────────┐    │
│   │                        RAG Engine                                │    │
│   │   ┌─────────────┐    ┌─────────────┐    ┌─────────────┐         │    │
│   │   │   BM25      │    │  Semantic   │    │   Symbol    │         │    │
│   │   │   Index     │    │  Embeddings │    │   Index     │         │    │
│   │   │  (lexical)  │    │  (384-dim)  │    │  (55,871)   │         │    │
│   │   └──────┬──────┘    └──────┬──────┘    └──────┬──────┘         │    │
│   │          │                  │                  │                 │    │
│   │          └────────┬─────────┴──────────────────┘                 │    │
│   │                   │                                              │    │
│   │                   ▼                                              │    │
│   │          ┌─────────────┐                                         │    │
│   │          │   Hybrid    │  166,043 chunks                         │    │
│   │          │   Search    │  RRF fusion                             │    │
│   │          └─────────────┘                                         │    │
│   └─────────────────────────────────────────────────────────────────┘    │
│                                                                          │
└──────────────────────────────────────────────────────────────────────────┘
```

## Data Flow: Search Query

```
┌──────────────────────────────────────────────────────────────────────────┐
│                         SEARCH QUERY FLOW                                 │
├──────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│   User: "Find ACTION_KEY encryption"                                     │
│                    │                                                     │
│                    ▼                                                     │
│   ┌─────────────────────────────────────────────────────────────────┐    │
│   │ MCP Request: evony_search(query="ACTION_KEY encryption", k=5)   │    │
│   └─────────────────────────────────────────────────────────────────┘    │
│                    │                                                     │
│          ┌────────┴────────┐                                             │
│          ▼                 ▼                                             │
│   ┌─────────────┐   ┌─────────────┐                                      │
│   │   BM25      │   │  Semantic   │                                      │
│   │   Search    │   │   Search    │                                      │
│   │  "ACTION"   │   │  embedding  │                                      │
│   │  "KEY"      │   │  similarity │                                      │
│   └──────┬──────┘   └──────┬──────┘                                      │
│          │                 │                                             │
│          │   k=20          │   k=20                                      │
│          ▼                 ▼                                             │
│   ┌─────────────────────────────────────────────────────────────────┐    │
│   │              Reciprocal Rank Fusion (RRF)                        │    │
│   │         score = Σ(1 / (60 + rank_bm25 + rank_semantic))         │    │
│   └─────────────────────────────────────────────────────────────────┘    │
│                    │                                                     │
│                    ▼                                                     │
│   ┌─────────────────────────────────────────────────────────────────┐    │
│   │ Results (top 5):                                                 │    │
│   │  1. ALL_ENCRYPTION_KEYS.py:1-17    (score: 0.027)               │    │
│   │  2. hub_ultimate.py:681-692        (score: 0.016)               │    │
│   │  3. exploit_engine.py:183-198      (score: 0.016)               │    │
│   │  4. mega_toolkit.py:511-522        (score: 0.016)               │    │
│   │  5. borg_toolkit.py:37-47          (score: 0.016)               │    │
│   └─────────────────────────────────────────────────────────────────┘    │
│                                                                          │
└──────────────────────────────────────────────────────────────────────────┘
```
